<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>GML Viewer & Exporter</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    #map { height: 400px; margin-bottom: 1rem; }
    body { font-family: Arial, sans-serif; margin: 20px; }
    .tabs button { margin-right: 10px; padding: 5px 10px; cursor: pointer; }
    .tab-content { display: none; margin-top: 10px; }
    .tab-content.active { display: block; }
    .info-box, table { background: #f9f9f9; border: 1px solid #ccc; padding: 10px; margin-top: 10px; }
    table { border-collapse: collapse; width: 100%; }
    th, td { border: 1px solid #ddd; padding: 8px; }
    th { background-color: #f2f2f2; }
  </style>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.8.0/proj4.js"></script>
</head>
<body>
  <h1>GML Viewer & Exporter</h1>

  <div>
    <input type="file" id="fileInput" accept=".gml" />
  </div>

  <div id="map"></div>

  <div class="tabs">
    <button onclick="switchTab('table')">Tabela</button>
    <button onclick="switchTab('info')">Atrybuty obiektu</button>
    <button onclick="switchTab('layers')">Warstwy</button>
  </div>

  <div id="tab-table" class="tab-content"></div>
  <div id="tab-info" class="tab-content">Kliknij obiekt na mapie, aby wyświetlić szczegóły.</div>
  <div id="tab-layers" class="tab-content"></div>

  <script>
    const map = L.map('map').setView([52, 19], 6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    const layerGroups = {};
    const featuresByClass = {};
    const epsgDefs = {
      'EPSG:2176': '+proj=tmerc +lat_0=0 +lon_0=15 +k=0.999923 +x_0=5500000 +y_0=0 +ellps=GRS80 +units=m +no_defs',
      'EPSG:2177': '+proj=tmerc +lat_0=0 +lon_0=18 +k=0.999923 +x_0=6500000 +y_0=0 +ellps=GRS80 +units=m +no_defs',
      'EPSG:2178': '+proj=tmerc +lat_0=0 +lon_0=21 +k=0.999923 +x_0=7500000 +y_0=0 +ellps=GRS80 +units=m +no_defs',
      'EPSG:2179': '+proj=tmerc +lat_0=0 +lon_0=24 +k=0.999923 +x_0=8500000 +y_0=0 +ellps=GRS80 +units=m +no_defs'
    };

    Object.entries(epsgDefs).forEach(([code, def]) => proj4.defs(code, def));

    document.getElementById('fileInput').addEventListener('change', handleFile);

    function switchTab(id) {
      document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
      document.getElementById(`tab-${id}`).classList.add('active');
    }

    function handleFile(evt) {
      const file = evt.target.files[0];
      const reader = new FileReader();
      reader.onload = function(e) {
        const xml = new DOMParser().parseFromString(e.target.result, 'application/xml');
        parseGML(xml);
      };
      reader.readAsText(file);
    }

    function transformCoords(x, y, srsName) {
      const code = `EPSG:${srsName.split('EPSG::')[1]}`;
      return proj4.defs(code) ? proj4(code, 'EPSG:4326', [y, x]) : [x, y];
    }

    function parseGML(xml) {
      const members = xml.getElementsByTagNameNS('*', 'featureMember');
      Array.from(members).forEach(member => {
        const feature = member.firstElementChild;
        const cls = feature.localName;
        const geom = feature.querySelector('Point, LineString, Polygon');
        if (!geom) return;

        const srsName = geom.getAttribute('srsName') || '';
        let geometry = null;

        if (geom.localName === 'Point') {
          const coords = geom.querySelector('pos').textContent.split(' ').map(Number);
          const [x, y] = transformCoords(coords[0], coords[1], srsName);
          geometry = { type: 'Point', coordinates: [x, y] };
        } else if (geom.localName === 'LineString') {
          const coords = geom.querySelector('posList').textContent.trim().split(/\s+/).map(Number);
          const coordinates = [];
          for (let i = 0; i < coords.length; i += 2) {
            coordinates.push(transformCoords(coords[i], coords[i + 1], srsName));
          }
          geometry = { type: 'LineString', coordinates };
        } else if (geom.localName === 'Polygon') {
          const posList = geom.querySelector('posList').textContent.trim().split(/\s+/).map(Number);
          const coordinates = [];
          for (let i = 0; i < posList.length; i += 2) {
            coordinates.push(transformCoords(posList[i], posList[i + 1], srsName));
          }
          geometry = { type: 'Polygon', coordinates: [coordinates] };
        }

        const properties = {};
        Array.from(feature.children).forEach(el => {
          if (!el.children.length) properties[el.localName] = el.textContent;
        });

        if (!featuresByClass[cls]) featuresByClass[cls] = [];
        featuresByClass[cls].push({ type: 'Feature', geometry, properties });
      });

      Object.entries(featuresByClass).forEach(([cls, features]) => {
        const layer = L.geoJSON({ type: 'FeatureCollection', features }, {
          onEachFeature: (feature, layer) => {
            layer.on('click', () => showFeatureInfo(feature.properties));
          }
        }).addTo(map);

        layerGroups[cls] = layer;
        addLayerControl(cls, layer);
      });

      switchTab('table');
      buildDataTable();
    }

    function showFeatureInfo(properties) {
      const info = document.getElementById('tab-info');
      info.innerHTML = '<strong>Dane obiektu:</strong><br>' +
        Object.entries(properties).map(([k, v]) => `<strong>${k}</strong>: ${v}`).join('<br>');
    }

    function buildDataTable() {
      const tableDiv = document.getElementById('tab-table');
      let html = '';
      Object.entries(featuresByClass).forEach(([cls, features]) => {
        if (features.length === 0) return;
        const keys = Object.keys(features[0].properties);
        html += `<h3>${cls}</h3><table><thead><tr>${keys.map(k => `<th>${k}</th>`).join('')}</tr></thead><tbody>`;
        features.forEach(f => {
          html += '<tr>' + keys.map(k => `<td>${f.properties[k] || ''}</td>`).join('') + '</tr>';
        });
        html += '</tbody></table>';
      });
      tableDiv.innerHTML = html;
    }

    function addLayerControl(name, layer) {
      const container = document.getElementById('tab-layers');
      const id = `layer-${name}`;
      const checkbox = document.createElement('input');
      checkbox.type = 'checkbox';
      checkbox.id = id;
      checkbox.checked = true;
      checkbox.addEventListener('change', () => {
        if (checkbox.checked) {
          map.addLayer(layer);
        } else {
          map.removeLayer(layer);
        }
      });
      const label = document.createElement('label');
      label.htmlFor = id;
      label.textContent = name;
      container.appendChild(checkbox);
      container.appendChild(label);
      container.appendChild(document.createElement('br'));
    }
  </script>
</body>
</html>
